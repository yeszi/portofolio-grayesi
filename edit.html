<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Konten - Admin Grayesi</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { margin: 0; background-color: #1f1f1f; color: white; }
    header, nav { background-color: #2e2e2e; padding: 20px; text-align: center; }
    header h1 { color: #f9a826; }
    nav a { color: #f7f7f7; margin: 0 10px; text-decoration: none; font-weight: 500; }
    nav a:hover { color: #f9a826; }
    .container { padding: 20px; }
    section { background-color: #2a2a2a; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
    h2 { color: #f9a826; }
    .item { margin-bottom: 20px; padding: 10px; background: #333; border-radius: 8px; }
    .item input, .item textarea {
      width: 100%; margin: 5px 0; padding: 10px; border-radius: 8px; border: none;
      background-color: #444; color: white;
    }
    .item button {
      background-color: #f9a826; color: black; font-weight: 600; padding: 10px; border: none;
      border-radius: 8px; cursor: pointer; margin-top: 5px;
    }
    .item button:hover { background-color: #ffaa00; }
    img { max-width: 100px; display: block; margin-top: 10px; }
  </style>
</head>
<body>

<header>
  <h1>Edit Konten - Admin Grayesi</h1>
</header>

<nav>
  <a href="admin_dashboard.html">Home Admin</a>
  <a href="index.html">Log Out</a>
</nav>

<div class="container" id="content"></div>

<script>
const SUPABASE_URL = 'https://owqdtbzhnxbxdsjrlzsa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93cWR0YnpobnhieGRzanJsenNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NzA1MjMsImV4cCI6MjA2NjQ0NjUyM30.cNmvpc_pBV89o9GHMU2CL0bSdgkdavAZuxB_w0Gv4gA';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const menus = [
  { table: 'projects', title: 'Projects', bucket: 'projectimages' },
  { table: 'experience', title: 'Experience', bucket: 'experienceimages' },
  { table: 'activity', title: 'My Activity', bucket: 'activityimages' },
  { table: 'articles', title: 'My Articles', bucket: 'articleimages' },
  { table: 'about_me', title: 'About Me', bucket: 'aboutimages' }
];

async function uploadImage(bucket, file) {
  const fileName = `${Date.now()}-${file.name}`;
  const { error } = await supabase.storage.from(bucket).upload(fileName, file);
  if (error) return null;
  return supabase.storage.from(bucket).getPublicUrl(fileName).data.publicUrl;
}

async function updateItem(table, id, title, description, image_url, link = null) {
  const updateData = { title, description, image_url };
  if (link) updateData.link = link;
  const { error } = await supabase.from(table).update(updateData).eq('id', id);
  if (error) alert('Gagal update: ' + error.message);
}

function renderSection({ table, title, bucket }) {
  const section = document.createElement('section');
  section.innerHTML = `<h2>${title}</h2><div id="list-${table}">Loading...</div>`;
  document.getElementById('content').appendChild(section);
  fetchData(table, bucket);

  supabase.channel(`realtime:${table}`).on('postgres_changes', { event: '*', schema: 'public', table }, payload => {
    fetchData(table, bucket);
  }).subscribe();
}

async function fetchData(table, bucket) {
  const { data, error } = await supabase.from(table).select('*');
  if (error) return;
  const container = document.getElementById(`list-${table}`);
  container.innerHTML = '';
  data.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <input value="${item.title}" id="title-${table}-${item.id}" />
      <textarea id="desc-${table}-${item.id}">${item.description}</textarea>
      ${item.link !== undefined ? `<input value="${item.link}" id="link-${table}-${item.id}" />` : ''}
      <input type="file" id="file-${table}-${item.id}" />
      <img src="${item.image_url}" />
      <button onclick="handleEdit('${table}', ${item.id}, '${bucket}', ${item.link !== undefined})">Update</button>
    `;
    container.appendChild(div);
  });
}

async function handleEdit(table, id, bucket, hasLink) {
  const title = document.getElementById(`title-${table}-${id}`).value;
  const description = document.getElementById(`desc-${table}-${id}`).value;
  const fileInput = document.getElementById(`file-${table}-${id}`);
  let image_url = null;
  if (fileInput.files[0]) image_url = await uploadImage(bucket, fileInput.files[0]);
  if (!image_url) {
    const { data } = await supabase.from(table).select('image_url').eq('id', id).single();
    image_url = data.image_url;
  }
  const link = hasLink ? document.getElementById(`link-${table}-${id}`).value : null;
  updateItem(table, id, title, description, image_url, link);
}

window.addEventListener('DOMContentLoaded', () => {
  menus.forEach(menu => renderSection(menu));
});
</script>

</body>
</html>
